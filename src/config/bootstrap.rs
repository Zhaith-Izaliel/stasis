// Author: Dustin Pilgrim
// License: MIT
//
// Description: Creates an initial ~/.config/stasis/stasis.rune on first run.
// Chooses a desktop vs laptop template based on chassis detection.

use std::fs;
use std::io;

use crate::core::utils::{detect_chassis, ChassisKind};

pub fn ensure_user_config_exists() -> io::Result<()> {
    let path = super::default_user_config_path();

    // Ensure parent dir exists
    if let Some(dir) = path.parent() {
        if !dir.exists() {
            fs::create_dir_all(dir)?;
        }
    }

    // If already present, do nothing.
    if path.exists() {
        return Ok(());
    }

    let contents = generate_default_config();
    fs::write(&path, contents)?;

    eventline::info!("Stasis: created default config at {}", path.display());
    Ok(())
}

fn generate_default_config() -> String {
    match detect_chassis() {
        ChassisKind::Laptop => default_laptop_config(),
        _ => default_desktop_config(), // Desktop + Unknown fall back here
    }
}

fn default_laptop_config() -> String {
    r#"
# This file was auto-generated by Stasis on first run
# Feel free to customize it to your needs
# Master config reference: `/etc/stasis/stasis.rune`

@author "Dustin Pilgrim"
@description "Lightweight feature packed idle manager for Wayland"

# IMPORTANT (new semantics):
# - Everything lives under `default:` (and optional profile blocks).
# - On laptops, Stasis chooses between:
#     `default.ac:` and `default.battery:`
#   depending on current power source.

active_profile null

default:
  # Optional: run before suspending (e.g., ensure lock is up)
  #pre_suspend_command "swaylock"

  monitor_media true
  ignore_remote_media true # ignore remote players (spotify/kdeconnect/etc.)

  # Optional: ignore these media sources for media inhibit (case-insensitive)
  #media_blacklist ["spotify"]

  # Debounce window in seconds before starting the plan (default 0)
  #debounce_seconds 4

  # Notify when resuming from IPC pause (e.g., `stasis pause 1h`)
  #notify_on_unpause true

  # Global gate: notifications before steps only happen if this is true
  #notify_before_action true

  # App/process inhibit patterns (strings or regex literals)
  inhibit_apps [
    "vlc"
    "mpv"
    r"steam_app_.*"
  ]

  # Laptop plan: AC power (relaxed)
  ac:
    brightness:
      timeout 300 # 5 minute(s)
      command "brightnessctl set 50%"
    end

    dpms:
      timeout 120 # 2 minute(s) after brightness
      command "niri msg action power-off-monitors"
      resume_command "niri msg action power-on-monitors"
    end

    lock_screen:
      timeout 180 # 3 minute(s) after dpms
      command "swaylock"

      # Optional per-step notification:
      #notification "Locking session soon"
      #notify_seconds_before 10
    end

    suspend:
      timeout 600 # 10 minute(s) after lock
      command "systemctl suspend"
    end
  end

  # Laptop plan: Battery power (aggressive)
  battery:
    brightness:
      timeout 60 # 1 minute(s)
      command "brightnessctl set 30%"
    end

    dpms:
      timeout 30 # 30 second(s) after brightness
      command "niri msg action power-off-monitors"
      resume_command "niri msg action power-on-monitors"
    end

    lock_screen:
      timeout 60 # 1 minute(s) after dpms
      command "swaylock"

      # Optional loginctl integration for lock step only:
      #use_loginctl true
    end

    suspend:
      timeout 120 # 2 minute(s) after lock
      command "systemctl suspend"
    end
  end
end
"#
    .trim_start()
    .to_string()
}

fn default_desktop_config() -> String {
    r#"
# This file was auto-generated by Stasis on first run
# Feel free to customize it to your needs
# Master config reference: `/etc/stasis/stasis.rune`

@author "Dustin Pilgrim"
@description "Lightweight feature packed idle manager for Wayland"

active_profile null

default:
  # Optional: run before suspending (e.g., ensure lock is up)
  #pre_suspend_command "swaylock"

  monitor_media true
  ignore_remote_media true # ignore remote players (spotify/kdeconnect/etc.)

  # Optional: ignore these media sources for media inhibit (case-insensitive)
  #media_blacklist ["spotify"]

  # Debounce window in seconds before starting the plan (default 0)
  #debounce_seconds 4

  # Notify when resuming from IPC pause (e.g., `stasis pause 1h`)
  #notify_on_unpause true

  # Global gate: notifications before steps only happen if this is true
  #notify_before_action true

  # App/process inhibit patterns (strings or regex literals)
  inhibit_apps [
    "vlc"
    "mpv"
    r"steam_app_.*"
  ]

  lock_screen:
    timeout 300 # 5 minute(s)
    command "swaylock"

    # Optional per-step notification:
    #notification "Locking in 10s"
    #notify_seconds_before 10

    # Optional loginctl integration for lock step only:
    #use_loginctl true
  end

  dpms:
    timeout 60 # 1 minute(s) after lock
    command "niri msg action power-off-monitors"
    resume_command "niri msg action power-on-monitors"
  end

  suspend:
    timeout 1800 # 30 minute(s) after dpms
    command "systemctl suspend"
  end
end
"#
    .trim_start()
    .to_string()
}
